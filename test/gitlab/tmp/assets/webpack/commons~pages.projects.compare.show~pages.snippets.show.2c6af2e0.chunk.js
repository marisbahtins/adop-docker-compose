(this.webpackJsonp=this.webpackJsonp||[]).push([[22],{125:function(e,t,i){"use strict";function n(e,t){var i=t.x,n=t.y,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=document.createElement("button");return r.concat(["js-image-badge"]).forEach(function(e){return a.classList.add(e)}),a.setAttribute("type","button"),a.setAttribute("disabled",!0),a.dataset.noteId=e,a.style.left="".concat(i,"px"),a.style.top="".concat(n,"px"),a}function r(e,t){var i=t.x,n=t.y,r=document.createElement("button");r.classList.add("btn-transparent"),r.classList.add("comment-indicator"),r.setAttribute("type","button"),r.style.left="".concat(i,"px"),r.style.top="".concat(n,"px"),r.innerHTML=gl.utils.spriteIcon("image-comment-dark"),e.appendChild(r)}var a={x:0,y:0,width:0,height:0},o=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=t.noteId,n=t.discussionId;this.actual=t.actual||a,this.browser=t.browser||a,this.noteId=i,this.discussionId=n,t.imageEl&&!t.browser&&(this.browser=T.resizeCoordinatesToImageElement(t.imageEl,this.actual))},s=i(0),c=i.n(s);function u(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function l(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.el=t,this.canCreateNote=!(!i||!i.canCreateNote),this.renderCommentBadge=!(!i||!i.renderCommentBadge),this.$noteContainer=c()(".note-container",this.el),this.imageBadges=[]}var t,i,n;return t=e,(i=[{key:"init",value:function(){this.imageFrameEl=this.el.querySelector(".diff-file .js-image-frame"),this.imageEl=this.imageFrameEl.querySelector("img"),this.bindEvents()}},{key:"bindEvents",value:function(){var e;this.imageClickedWrapper=this.imageClicked.bind(this),this.imageBlurredWrapper=T.removeCommentIndicator.bind(null,this.imageFrameEl),this.addBadgeWrapper=this.addBadge.bind(this),this.removeBadgeWrapper=this.removeBadge.bind(this),this.renderBadgesWrapper=this.renderBadges.bind(this),(e=this.imageEl).complete&&0!==e.naturalHeight?this.renderBadges():this.imageEl.addEventListener("load",this.renderBadgesWrapper),this.$noteContainer.on("click",".js-diff-notes-toggle",T.toggleCollapsed),c()(this.el).on("click",".comment-indicator",T.commentIndicatorOnClick),this.canCreateNote&&(this.el.addEventListener("click.imageDiff",this.imageClickedWrapper),this.el.addEventListener("blur.imageDiff",this.imageBlurredWrapper),this.el.addEventListener("addBadge.imageDiff",this.addBadgeWrapper),this.el.addEventListener("removeBadge.imageDiff",this.removeBadgeWrapper))}},{key:"imageClicked",value:function(e){var t=e.detail,i=T.getTargetSelection(t),n=t.currentTarget;T.setPositionDataAttribute(n,i.actual),T.showCommentIndicator(this.imageFrameEl,i.browser)}},{key:"renderBadges",value:function(){u(this.el.querySelectorAll(".note-container .discussion-notes .notes")).forEach(this.renderBadge.bind(this))}},{key:"renderBadge",value:function(e,t){var i=T.generateBadgeFromDiscussionDOM(this.imageFrameEl,e);this.imageBadges.push(i);var n={coordinate:i.browser,noteId:i.noteId};if(this.renderCommentBadge)T.addImageCommentBadge(this.imageFrameEl,n);else{var r=Object.assign({},n,{badgeText:t+1});T.addImageBadge(this.imageFrameEl,r)}}},{key:"addBadge",value:function(e){var t=e.detail,i=t.x,n=t.y,r=t.width,a=t.height,s=t.noteId,c=t.discussionId,u=this.imageBadges.length+1,l=new o({actual:{x:i,y:n,width:r,height:a},imageEl:this.imageFrameEl.querySelector("img"),noteId:s,discussionId:c});this.imageBadges.push(l),T.addImageBadge(this.imageFrameEl,{coordinate:l.browser,badgeText:u,noteId:s}),T.addAvatarBadge(this.el,{detail:{noteId:s,badgeNumber:u}});var d=this.el.querySelector("#discussion_".concat(c));T.updateDiscussionBadgeNumber(d,u)}},{key:"removeBadge",value:function(e){var t=this,i=e.detail.badgeNumber,n=i-1,r=this.imageFrameEl.querySelectorAll(".badge");this.imageBadges.length!==i&&this.imageBadges.forEach(function(e,i){if(i>n){var a=e.discussionId,o=i,s=t.el.querySelector("#discussion_".concat(a));r[i].innerText=o,T.updateDiscussionBadgeNumber(s,o),T.updateDiscussionAvatarBadgeNumber(s,o)}}),this.imageBadges.splice(n,1),r[n].remove()}}])&&l(t.prototype,i),n&&l(t,n),e}(),h={TWO_UP:"TWO_UP",SWIPE:"SWIPE",ONION_SKIN:"ONION_SKIN"};function g(e){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function m(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,t){return!t||"object"!==g(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function w(e,t,i){return(w="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var I=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),v(this,y(t).apply(this,arguments))}var i,n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(t,d),i=t,(n=[{key:"init",value:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:h.TWO_UP;this.imageFrameEls=(m(e={},h.TWO_UP,this.el.querySelector(".two-up .js-image-frame")),m(e,h.SWIPE,this.el.querySelector(".swipe .js-image-frame")),m(e,h.ONION_SKIN,this.el.querySelector(".onion-skin .js-image-frame")),e);var n=this.el.querySelector(".view-modes-menu");this.viewModesEls=(m(t={},h.TWO_UP,n.querySelector(".two-up")),m(t,h.SWIPE,n.querySelector(".swipe")),m(t,h.ONION_SKIN,n.querySelector(".onion-skin")),t),this.currentView=i,this.generateImageEls(),this.bindEvents()}},{key:"generateImageEls",value:function(){var e=this;this.imageEls={},Object.getOwnPropertyNames(h).forEach(function(t){e.imageEls[t]=e.imageFrameEls[t].querySelector("img")})}},{key:"bindEvents",value:function(){w(y(t.prototype),"bindEvents",this).call(this),this.changeToViewTwoUp=this.changeView.bind(this,h.TWO_UP),this.changeToViewSwipe=this.changeView.bind(this,h.SWIPE),this.changeToViewOnionSkin=this.changeView.bind(this,h.ONION_SKIN),this.viewModesEls[h.TWO_UP].addEventListener("click",this.changeToViewTwoUp),this.viewModesEls[h.SWIPE].addEventListener("click",this.changeToViewSwipe),this.viewModesEls[h.ONION_SKIN].addEventListener("click",this.changeToViewOnionSkin)}},{key:"changeView",value:function(e){if(t=e,Object.getOwnPropertyNames(h).find(function(e){return e===t})){var t,i=T.removeCommentIndicator(this.imageFrameEl);this.currentView=e,f(this.imageFrameEl.querySelectorAll(".badge")).map(function(e){return e.remove()}),this.imageBadges=[],setTimeout(this.renderNewView.bind(this,i),250)}}},{key:"renderNewView",value:function(e){if(this.renderBadges(),e.removed){var t=T.resizeCoordinatesToImageElement(this.imageEl,{x:e.x,y:e.y,width:e.image.width,height:e.image.height});T.showCommentIndicator(this.imageFrameEl,t)}}},{key:"imageEl",get:function(){return this.imageEls[this.currentView]}},{key:"imageFrameEl",get:function(){return this.imageFrameEls[this.currentView]}}])&&p(i.prototype,n),r&&p(i,r),t}();function E(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw a}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function S(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var O=900,k=["two-up","swipe"],B=function(){function e(t){var i,n,r,a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r={"two-up":function(){return c()(".two-up.view .wrap",this.file).each((e=this,function(t,i){return c()("img",i).each(function(){if(c()(this).width()>O/2)return c()(this).width(O/2)}),e.requestImageInfo(c()("img",i),function(e,t){return c()(".image-info .meta-width",i).text(e+"px"),c()(".image-info .meta-height",i).text(t+"px"),c()(".image-info",i).removeClass("hide")})}));var e},swipe:function(){var e,t,i;return t=0,e=0,c()(".swipe.view",this.file).each((i=this,function(n,r){var a,o,s,u,l;a=E(i.prepareFrames(r),2),t=a[0],e=a[1],u=c()(".swipe-frame",r),o=c()(".swipe-wrap",r),s=c()(".swipe-bar",r),u.css({width:t+16,height:e+28}),o.css({width:t+1,height:e+2}),s.css({left:1}),l=parseInt(o.css("right").replace("px",""),10),i.initDraggable(s,l,function(e,i){i>0&&i<u.width()-2*l&&(o.width(t+1-i),s.css("left",i))})}))},"onion-skin":function(){var e,t,i,n;return i=0,t=0,e=c()(".drag-track",this.file).width()-c()(".dragger",this.file).width(),c()(".onion-skin.view",this.file).each((n=this,function(r,a){var o,s,u,l,d,h;o=E(n.prepareFrames(a),2),i=o[0],t=o[1],s=c()(".onion-skin-frame",a),d=c()(".frame.added",a),u=c()(".drag-track",a),l=c()(".dragger",u),s.css({width:i+16,height:t+28}),c()(".swipe-wrap",a).css({width:i+1,height:t+2}),l.css({left:e}),d.css("opacity",1),h=parseInt(d.css("right").replace("px",""),10),n.initDraggable(l,h,function(t,i){var n=i/e;n>=0&&n<=1&&(l.css("left",i),d.css("opacity",n))})}))}},(n="views")in(i=this)?Object.defineProperty(i,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):i[n]=r,this.file=t,this.requestImageInfo(c()(".two-up.view .frame.deleted img",this.file),(a=this,function(e,t){return a.requestImageInfo(c()(".two-up.view .frame.added img",a.file),function(e,t){a.initViewModes(),c()(".two-up.view img",a.file).waitForImages(function(){a.initView("two-up")})})}))}var t,i,n;return t=e,(i=[{key:"initViewModes",value:function(){var e,t=k[0];return c()(".view-modes",this.file).removeClass("hide"),c()(".view-modes-menu",this.file).on("click","li",(e=this,function(t){if(!c()(t.currentTarget).hasClass("active"))return e.activateViewMode(t.currentTarget.className)})),this.activateViewMode(t)}},{key:"activateViewMode",value:function(e){return c()(".view-modes-menu li",this.file).removeClass("active").filter("."+e).addClass("active"),c()(".view:visible:not(."+e+")",this.file).fadeOut(200,(t=this,function(){return c()(".view."+e,t.file).fadeIn(200),t.initView(e)}));var t}},{key:"initView",value:function(e){return this.views[e].call(this)}},{key:"initDraggable",value:function(e,t,i){var n=!1,r=c()("body"),a=e.parent();e.off("mousedown").on("mousedown",function(){n=!0,r.css("user-select","none")}),r.off("mouseup").off("mousemove").on("mouseup",function(){n=!1,r.css("user-select","")}).on("mousemove",function(e){var r;n&&(r=e.pageX-(a.offset().left+t),i(e,r))})}},{key:"prepareFrames",value:function(e){var t,i;return i=0,t=0,c()(".frame",e).each(function(e,n){var r,a;return a=c()(n).width(),r=c()(n).height(),i=a>i?a:i,t=r>t?r:t}).css({width:i,height:t}),[i,t]}},{key:"requestImageInfo",value:function(e,t){var i,n=e.get(0);if(n)return n.complete?t.call(this,n.naturalWidth,n.naturalHeight):e.on("load",(i=this,function(){return t.call(i,n.naturalWidth,n.naturalHeight)}))}}])&&S(t.prototype,i),n&&S(t,n),e}();var T=t.a={addCommentIndicator:r,removeCommentIndicator:function(e){var t=e.querySelector(".comment-indicator"),i=e.querySelector("img"),n=!!t,r={};return n&&(r={x:parseInt(t.style.left,10),y:parseInt(t.style.top,10),image:{width:i.width,height:i.height}},t.remove()),Object.assign({},r,{removed:n})},showCommentIndicator:function(e,t){var i=t.x,n=t.y,a=e.querySelector(".comment-indicator");a?(a.style.left="".concat(i,"px"),a.style.top="".concat(n,"px")):r(e,t)},commentIndicatorOnClick:function(e){e.stopPropagation(),e.currentTarget.closest(".diff-viewer").querySelector(".note-container .note-textarea").focus()},addImageBadge:function(e,t){var i=t.coordinate,r=t.badgeText,a=n(t.noteId,i,["badge","badge-pill"]);a.innerText=r,e.appendChild(a)},addImageCommentBadge:function(e,t){var i=t.coordinate,r=n(t.noteId,i,["image-comment-badge"]);r.innerHTML=gl.utils.spriteIcon("image-comment-dark"),e.appendChild(r)},addAvatarBadge:function(e,t){var i=t.detail,n=i.noteId,r=i.badgeNumber,a=e.querySelector("#".concat(n," .badge"));a.innerText=r,a.classList.remove("hidden")},setPositionDataAttribute:function(e,t){var i=t.x,n=t.y,r=t.width,a=t.height,o=e.dataset.position,s=Object.assign({},JSON.parse(o),{x:i,y:n,width:r,height:a});e.setAttribute("data-position",JSON.stringify(s))},updateDiscussionAvatarBadgeNumber:function(e,t){e.querySelector(".image-diff-avatar-link .badge").innerText=t},updateDiscussionBadgeNumber:function(e,t){e.querySelector(".badge").innerText=t},toggleCollapsed:function(e){var t=e.currentTarget.closest(".discussion-notes"),i=t.querySelector(".discussion-form"),n=t.classList.contains("collapsed");n?t.classList.remove("collapsed"):t.classList.add("collapsed"),i&&!n?i.style.display="none":i&&n&&(i.style.display="block")},resizeCoordinatesToImageElement:function(e,t){var i=t.x,n=t.y,r=t.width,a=t.height,o=e.width,s=e.height,c=o/r,u=s/a;return{x:Math.round(i*c),y:Math.round(n*u),width:o,height:s}},generateBadgeFromDiscussionDOM:function(e,t){var i=JSON.parse(t.dataset.position),n=t.querySelector(".note");return new o({actual:i,imageEl:e.querySelector("img"),noteId:n.id,discussionId:t.dataset.discussionId})},getTargetSelection:function(e){var t=e.currentTarget.querySelector("img"),i=e.offsetX,n=e.offsetY,r=t.width,a=t.height,o=t.naturalWidth,s=t.naturalHeight,c=o/r,u=s/a,l=Math.max(0,i)&&Math.min(i,r),d=Math.max(0,n)&&Math.min(n,a);return{browser:{x:l,y:d,width:r,height:a},actual:{x:Math.round(l*c),y:Math.round(d*u),width:o,height:s}}},initImageDiff:function(e,t,i){var n,r={canCreateNote:t,renderCommentBadge:i};return new B(e),e.querySelector(".diff-file .js-single-image")?(n=new d(e,r)).init():e.querySelector(".diff-file .js-replaced-image")&&(n=new I(e,r)).init(),n}}}}]);
//# sourceMappingURL=commons~pages.projects.compare.show~pages.snippets.show.2c6af2e0.chunk.js.map